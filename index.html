<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BackTracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FIREBASE SDKs (Modular v9) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // Expose to window for use in main script
        window.fbLib = { initializeApp, getDatabase, ref, set, get, onValue };
    </script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --subtext: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .full-screen-center {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg); z-index: 100;
        }

        .app-container {
            display: none; /* Hidden by default */
            flex-direction: column; height: 100vh; width: 100%;
        }

        .scroll-area {
            flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 80px;
        }

        .content-wrapper {
            max-width: 500px; margin: 0 auto;
        }

        /* --- LOGIN CARD --- */
        .login-card {
            background: var(--card-bg); width: 90%; max-width: 360px;
            padding: 32px 24px; border-radius: var(--radius);
            box-shadow: var(--shadow); text-align: center;
        }

        .login-title { font-size: 28px; font-weight: 800; color: var(--primary); margin: 0 0 8px 0; }
        .login-subtitle { color: var(--subtext); font-size: 14px; margin-bottom: 24px; }

        .input-group { margin-bottom: 16px; text-align: left; }
        .input-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
        
        .form-input {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: 8px; font-size: 16px; outline: none; transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--primary); }
        
        .pin-wrapper { position: relative; }
        .pin-wrapper input { padding-right: 44px; }
        .toggle-pin {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: var(--subtext); font-size: 20px; user-select: none;
        }

        .error-msg {
            color: var(--danger); font-size: 13px; margin-top: 6px;
            min-height: 20px; opacity: 0; transition: opacity 0.2s;
        }
        .error-msg.visible { opacity: 1; }

        .btn-primary {
            width: 100%; padding: 16px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 18px; font-weight: 600;
            cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-primary:active:not(:disabled) { background: var(--primary-dark); }

        /* --- LOADING SPINNER --- */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); border-radius: var(--radius);
            display: flex; align-items: center; justify-content: center;
            z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .loader-overlay.active { opacity: 1; pointer-events: auto; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- DASHBOARD (Simplified for this file) --- */
        .card {
            background: var(--card-bg); border-radius: 12px; padding: 16px;
            margin-bottom: 16px; border: 1px solid var(--border); box-shadow: var(--shadow);
        }
        .logout-btn {
            background: none; border: none; color: var(--subtext); font-size: 14px;
            text-decoration: underline; cursor: pointer; margin-top: 20px;
        }
        
        /* --- MODAL FOR DASHBOARD --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; padding: 24px; border-radius: 12px;
            width: 90%; max-width: 350px; text-align: center;
        }
        .slider-row { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen" class="full-screen-center">
        <div class="login-card">
            <h1 class="login-title">BackTracker</h1>
            <p class="login-subtitle">Enter your details to continue</p>

            <div class="input-group">
                <label class="input-label">Name</label>
                <input type="text" id="login-name" class="form-input" placeholder="Enter your name" autocomplete="off">
                <div id="name-error" class="error-msg">Name must be at least 2 letters</div>
            </div>

            <div class="input-group">
                <label class="input-label">4-Digit PIN</label>
                <div class="pin-wrapper">
                    <input type="password" id="login-pin" class="form-input" placeholder="Create/enter PIN" maxlength="4">
                    <span class="toggle-pin" id="pin-toggle">üëÅÔ∏è</span>
                </div>
                <div id="pin-error" class="error-msg">PIN must be exactly 4 digits</div>
            </div>

            <button id="btn-login" class="btn-primary" disabled>Start Tracking</button>
            
            <!-- Loading Spinner -->
            <div id="login-loader" class="loader-overlay">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- 2. DASHBOARD SCREEN -->
    <div id="app-screen" class="app-container">
        <div class="scroll-area">
            <div class="content-wrapper">
                <div class="card" style="text-align: center;">
                    <h2 id="welcome-msg">Welcome!</h2>
                    <p>Check in daily to track your progress.</p>
                    <button class="btn-primary" onclick="app.openCheckIn()">Daily Check-In ‚úÖ</button>
                    <button class="logout-btn" onclick="authManager.logout()">Switch User / Logout</button>
                </div>

                <!-- Stats Placeholder -->
                <div class="card">
                    <h3>Stats</h3>
                    <p>Streak: <strong id="dash-streak">0</strong> Days</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CHECK-IN MODAL -->
    <div id="checkin-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Did you exercise today?</h3>
            <div class="slider-row">
                <span>üòä</span><span>üòê</span><span>üò£</span><span>ü§ï</span><span>üò∞</span>
            </div>
            <input type="range" id="pain-slider" min="0" max="10" value="0" style="width:100%">
            <p id="pain-val">Pain Level: 0</p>
            <button class="btn-primary" onclick="app.saveCheckIn()">Save Entry</button>
            <button class="btn-primary" style="background:transparent; color:#64748b; border:1px solid #e2e8f0; margin-top:10px;" onclick="app.closeCheckIn()">Cancel</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THE OBJECT BELOW WITH YOUR FIREBASE PROJECT CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBIKH1UPdSez2bvFvmzx6U7dSEpRCCxgK0",
            authDomain: "back-track-d530d.firebaseapp.com",
            databaseURL: "https://back-track-d530d-default-rtdb.firebaseio.com",
            projectId: "back-track-d530d",
            storageBucket: "back-track-d530d.firebasestorage.app",
            messagingSenderId: "218745768188",
            appId: "1:218745768188:web:1a7b5711e1b4419caf2f79"
        };

        // --- GLOBAL STATE ---
        const db = window.fbLib.initializeApp(firebaseConfig);
        const rtdb = window.fbLib.getDatabase(db);
        
        const state = {
            userKey: null, // e.g. "johnsmith-1234"
            userData: null, // The full object from Firebase
            checkIns: []
        };

        // --- AUTH / LOGIN MANAGER ---
        const authManager = {
            inputs: {
                name: document.getElementById('login-name'),
                pin: document.getElementById('login-pin'),
                btn: document.getElementById('btn-login'),
                loader: document.getElementById('login-loader'),
                errors: {
                    name: document.getElementById('name-error'),
                    pin: document.getElementById('pin-error')
                }
            },

            init: function() {
                // 1. Check Auto-Login
                const savedUser = localStorage.getItem('currentUserKey');
                if (savedUser) {
                    this.verifyUser(savedUser);
                }

                // 2. Setup Listeners
                this.inputs.name.addEventListener('input', () => this.validate());
                this.inputs.pin.addEventListener('input', () => this.validate());
                
                // PIN Toggle
                document.getElementById('pin-toggle').addEventListener('click', (e) => {
                    const input = this.inputs.pin;
                    input.type = input.type === 'password' ? 'text' : 'password';
                    e.target.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üö´';
                });

                // Login Button
                this.inputs.btn.addEventListener('click', () => this.login());
            },

            validate: function() {
                const name = this.inputs.name.value;
                const pin = this.inputs.pin.value;
                let valid = true;

                // Name Validation: min 2 chars, letters (and spaces allowed for display, stripped for logic)
                const nameRegex = /^[a-zA-Z\s]{2,}$/;
                if (!nameRegex.test(name)) {
                    this.inputs.errors.name.classList.add('visible');
                    valid = false;
                } else {
                    this.inputs.errors.name.classList.remove('visible');
                }

                // PIN Validation: exactly 4 digits
                const pinRegex = /^\d{4}$/;
                if (!pinRegex.test(pin)) {
                    this.inputs.errors.pin.classList.add('visible');
                    valid = false;
                } else {
                    this.inputs.errors.pin.classList.remove('visible');
                }

                this.inputs.btn.disabled = !valid;
                return valid;
            },

            login: function() {
                const rawName = this.inputs.name.value.trim();
                const pin = this.inputs.pin.value;
                
                // Normalize Name: lowercase, remove spaces
                const normalizedName = rawName.toLowerCase().replace(/\s+/g, '');
                const userKey = `${normalizedName}-${pin}`;

                this.setLoading(true);
                this.verifyUser(userKey, rawName);
            },

            verifyUser: function(key, displayName = null) {
                const userRef = window.fbLib.ref(rtdb, 'users/' + key);
                
                window.fbLib.get(userRef).then((snapshot) => {
                    this.setLoading(false);

                    if (snapshot.exists()) {
                        // SCENARIO: Existing User
                        const data = snapshot.val();
                        state.userKey = key;
                        state.userData = data;
                        state.checkIns = data.checkIns || [];
                        
                        localStorage.setItem('currentUserKey', key);
                        app.showDashboard(`Welcome back, ${data.name}!`);
                    } else {
                        // SCENARIO: New User
                        if(!displayName) {
                            // Auto-login failed (key invalid or deleted)
                            this.logout(); 
                            return;
                        }

                        const newUser = {
                            name: displayName,
                            pin: key.split('-')[1], // Extract pin for storage
                            checkIns: [],
                            currentStreak: 0,
                            longestStreak: 0,
                            badges: []
                        };

                        // Create User in Firebase
                        window.fbLib.set(userRef, newUser).then(() => {
                            state.userKey = key;
                            state.userData = newUser;
                            state.checkIns = [];
                            
                            localStorage.setItem('currentUserKey', key);
                            app.showDashboard("Welcome!");
                        }).catch((error) => {
                            alert("Error creating user: " + error.message);
                        });
                    }
                }).catch((error) => {
                    this.setLoading(false);
                    alert("Connection Error: " + error.message);
                });
            },

            logout: function() {
                localStorage.removeItem('currentUserKey');
                location.reload();
            },

            setLoading: function(isLoading) {
                if(isLoading) this.inputs.loader.classList.add('active');
                else this.inputs.loader.classList.remove('active');
            }
        };

        // --- APP LOGIC (DASHBOARD) ---
        const app = {
            screens: {
                login: document.getElementById('login-screen'),
                app: document.getElementById('app-screen')
            },
            
            showDashboard: function(msg) {
                this.screens.login.style.display = 'none';
                this.screens.app.style.display = 'flex';
                if(msg) {
                    document.getElementById('welcome-msg').textContent = msg;
                    document.getElementById('welcome-msg').style.color = 'var(--primary)';
                    setTimeout(() => document.getElementById('welcome-msg').style.color = 'var(--text)', 2000);
                }
                this.updateStats();
            },

            updateStats: function() {
                const streak = this.calcStreak();
                document.getElementById('dash-streak').textContent = streak;
                
                // Update Streak in Firebase (Optional: could be done on check-in)
                // For simplicity in this demo, we calculate dynamically
            },

            calcStreak: function() {
                if(state.checkIns.length === 0) return 0;
                // Simple streak logic: consecutive days with exercise = true
                // Sorting dates descending
                const sorted = [...state.checkIns].sort((a,b) => new Date(b.date) - new Date(a.date));
                const today = new Date();
                today.setHours(0,0,0,0);
                
                let streak = 0;
                let checkDate = new Date(today);
                
                // Check backwards
                for(let i=0; i<365; i++) {
                    const dateStr = checkDate.toISOString().split('T')[0];
                    const entry = state.checkIns.find(c => c.date === dateStr);
                    
                    if(entry && entry.exercised) {
                        streak++;
                    } else if (entry && !entry.exercised) {
                        break; // Streak broken by missed day
                    } else if (!entry && i > 0) {
                        break; // Streak broken by missing data
                    }
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                return streak;
            },

            openCheckIn: function() {
                document.getElementById('checkin-modal').classList.add('active');
                document.getElementById('pain-slider').value = 0;
                this.updatePainDisplay(0);
            },

            closeCheckIn: function() {
                document.getElementById('checkin-modal').classList.remove('active');
            },

            updatePainDisplay: function(val) {
                document.getElementById('pain-val').textContent = `Pain Level: ${val}`;
            },

            saveCheckIn: function() {
                const pain = document.getElementById('pain-slider').value;
                const today = new Date().toISOString().split('T')[0];
                
                // Add Entry
                const entry = { date: today, painLevel: parseInt(pain), exercised: true }; // Simplified: assuming exercised if clicking Check-In
                state.checkIns.push(entry);

                // Save to Firebase
                const userRef = window.fbLib.ref(rtdb, 'users/' + state.userKey);
                // We update the checkIns array. Note: Realtime DB handles array indexes carefully.
                // Simple set update:
                window.fbLib.set(userRef, {
                    ...state.userData,
                    checkIns: state.checkIns
                }).then(() => {
                    this.closeCheckIn();
                    this.updateStats();
                    alert("Saved!");
                });
            }
        };

        // Slider Listener
        document.getElementById('pain-slider').addEventListener('input', (e) => {
            app.updatePainDisplay(e.target.value);
        });

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            authManager.init();
        });

    </script>
</body>
</html>
